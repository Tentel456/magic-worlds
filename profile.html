<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Профиль</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Site styles -->
  <link rel="stylesheet" href="assets/css/main.css" />
  <link rel="stylesheet" href="assets/css/octoground.css" />
  <link rel="stylesheet" href="assets/css/owl.carousel.min.css" />
  <link rel="stylesheet" href="assets/css/owl.theme.default.min.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
</head>
<body>
  <!-- Header (same as index) -->
  <header class="header">
    <div class="container header__inner">
      <a href="/" class="header__logo">
        <img src="./assets/images/logo.png" alt="logo" class="big_logo" />
        <img src="./assets/images/mobile.png" alt="mobile logo" class="mobile_logo" />
        <div class="header__brand">Путешествия</div>
      </a>

      <nav class="nav d-none d-xl-block">
        <ul class="nav__list">
          <li class="nav__item nav__item--has-dropdown">
            <a href="#" class="nav__link">
              <img src="./assets/images/icons/menu.png" alt="menu" />
              <p>Категории товаров и услуг</p>
              <img src="./assets/images/icons/arrow.png" alt="arrow" class="arrow" />
            </a>
          </li>

          <li class="nav__item">
            <a href="/profile" class="nav__link profile" style="display: none;">
              <img src="./assets/images/user.png" alt="user" />
              <div class="profile_info ms-1">
                <h6>@username</h6>
                <span>Баланс: 0,00₽</span>
              </div>

  <!-- Create Article Modal -->
  <div class="modal fade" id="createArticleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Новая статья</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Заголовок</label>
            <input type="text" class="form-control" id="articleTitle" placeholder="Заголовок статьи" />
          </div>
          <div class="mb-3">
            <label class="form-label">Текст</label>
            <textarea class="form-control" id="articleContent" rows="6" placeholder="Текст статьи..."></textarea>
          </div>
          <div class="alert alert-danger d-none" id="articleError"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-success" id="saveArticleBtn">Опубликовать</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Review Modal -->
  <div class="modal fade" id="createReviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Оставить отзыв</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Ваше имя</label>
            <input type="text" class="form-control" id="reviewerName" placeholder="Имя" />
          </div>
          <div class="mb-3">
            <label class="form-label">Оценка</label>
            <select class="form-select" id="reviewRating">
              <option value="5">5</option>
              <option value="4">4</option>
              <option value="3">3</option>
              <option value="2">2</option>
              <option value="1">1</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Отзыв</label>
            <textarea class="form-control" id="reviewContent" rows="4" placeholder="Ваши впечатления..."></textarea>
          </div>
          <div class="alert alert-danger d-none" id="reviewError"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-primary" id="saveReviewBtn">Отправить</button>
        </div>
      </div>
    </div>
  </div>
            </a>
            <a href="/login" class="nav__link profile">
              <svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7.5 8.75C9.22589 8.75 10.625 7.07107 10.625 5C10.625 2.92893 9.22589 1.25 7.5 1.25C5.77411 1.25 4.375 2.92893 4.375 5C4.375 7.07107 5.77411 8.75 7.5 8.75Z" fill="#114232" />
                <path d="M13.6251 11.9367C13.0626 10.8117 12.0001 9.87423 10.6251 9.31173C10.2501 9.18673 9.81264 9.18673 9.50014 9.37423C8.87514 9.74923 8.25014 9.93673 7.50014 9.93673C6.75014 9.93673 6.12514 9.74923 5.50014 9.37423C5.18764 9.24923 4.75014 9.18673 4.37514 9.37423C3.00014 9.93673 1.93764 10.8742 1.37514 11.9992C0.937636 12.8117 1.62514 13.7492 2.56264 13.7492H12.4376C13.3751 13.7492 14.0626 12.8117 13.6251 11.9367Z" fill="#114232" />
              </svg>
              <p style="margin: 0;">Войти</p>
            </a>
          </li>
        </ul>
      </nav>

      <!-- Mobile burger -->
      <button class="burger d-xl-none" id="burgerBtn" aria-label="Open menu">
        <span class="burger__bar"></span>
        <span class="burger__bar"></span>
        <span class="burger__bar"></span>
      </button>
    </div>
  </header>

  <!-- Main profile content -->
  <main class="og_pw" style="padding-top: 24px; padding-bottom: 60px;">
    <div class="container">
      <!-- Top header with About and author card -->
      <div class="row g-4 align-items-start">
        <div class="col-lg-8">
          <h5 class="mb-3" style="color:#6B7280;"><i class="fa-regular fa-user me-2"></i>Об Авторе</h5>
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <p class="mb-3" id="aboutText">Описание профиля пока не заполнено.</p>
              <p class="mb-0 text-muted small">Вы можете отредактировать описание в настройках профиля.</p>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card shadow-sm border-0">
            <div class="card-body d-flex flex-column align-items-center text-center">
              <img id="avatarImg" src="./assets/images/user.png" alt="avatar" width="120" height="120" class="rounded-circle border" />
              <h5 class="mt-3 mb-1" id="username">@user</h5>
              <div class="text-warning mb-2" id="ratingBox"></div>
              <div class="d-flex flex-wrap justify-content-center gap-2 mb-3">
                <span class="badge bg-light text-dark">Баланс: <span id="balance">0.00₽</span></span>
              </div>
              <div class="d-flex w-100 justify-content-center gap-2">
                <button id="editProfileBtn" class="btn btn-outline-secondary btn-sm" title="Редактировать"><i class="fa-regular fa-pen-to-square"></i></button>
                <button id="topupBtn" class="btn btn-outline-secondary btn-sm" title="Пополнить"><i class="fa-solid fa-wallet"></i></button>
                <button id="logoutBtn" class="btn btn-outline-secondary btn-sm" title="Выйти"><i class="fa-solid fa-right-from-bracket"></i></button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Author listings -->
      <div class="row g-3 align-items-center mt-4 mb-2">
        <div class="col"><h5 class="mb-0" style="color:#114232;"><i class="fa-regular fa-rectangle-list me-2"></i>Все объявления автора</h5></div>
        <div class="col-auto">
          <button id="prevPage" class="btn btn-sm btn-outline-secondary" title="Назад"><i class="fa-solid fa-chevron-left"></i></button>
          <button id="nextPage" class="btn btn-sm btn-outline-secondary" title="Вперёд"><i class="fa-solid fa-chevron-right"></i></button>
          <button id="createAdBtn" class="btn btn-sm btn-success ms-2" title="Создать объявление"><i class="fa-solid fa-plus"></i></button>
        </div>
      </div>
      <div id="adsEmpty" class="text-center text-muted py-4 d-none">
        <i class="fa-regular fa-rectangle-list fa-2x mb-2"></i>
        <div>Пока нет объявлений</div>
      </div>
      <div id="myAds" class="row g-3"></div>
      <div class="mt-2 d-flex justify-content-between align-items-center">
        <small class="text-muted" id="pagerInfo"></small>
        <small class="text-muted" id="totalInfo"></small>
      </div>

      <!-- Author articles -->
      <div class="row g-3 align-items-center mt-5 mb-2">
        <div class="col"><h5 class="mb-0" style="color:#114232;"><i class="fa-regular fa-newspaper me-2"></i>Все статьи автора</h5></div>
        <div class="col-auto">
          <button id="createArticleBtn" class="btn btn-sm btn-success" title="Создать статью"><i class="fa-solid fa-plus"></i></button>
        </div>
      </div>
      <div id="articlesEmpty" class="text-center text-muted py-4 d-none">
        <i class="fa-regular fa-newspaper fa-2x mb-2"></i>
        <div>Пока нет статей</div>
      </div>
      <div id="articlesList" class="row g-3"></div>

      <!-- Author reviews -->
      <div class="row g-3 align-items-center mt-5 mb-2">
        <div class="col"><h5 class="mb-0" style="color:#114232;"><i class="fa-regular fa-comments me-2"></i>Все отзывы об авторе</h5></div>
        <div class="col-auto">
          <button id="createReviewBtn" class="btn btn-sm btn-outline-secondary" title="Оставить отзыв"><i class="fa-regular fa-comment-dots"></i></button>
        </div>
      </div>
      <div id="reviewsEmpty" class="text-center text-muted py-4 d-none">
        <i class="fa-regular fa-comments fa-2x mb-2"></i>
        <div>Пока нет отзывов</div>
      </div>
      <div id="reviewsList" class="row g-3"></div>
    </div>
  </main>

  <div class="position-fixed top-0 end-0 p-3" style="z-index:1080;">
    <div id="toastContainer"></div>
  </div>

  <!-- Create Announcement Modal -->
  <div class="modal fade" id="createAdModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Новое объявление</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Заголовок</label>
            <input type="text" class="form-control" id="adTitle" placeholder="Короткий заголовок" />
          </div>
          <div class="mb-3">
            <label class="form-label">Краткое описание</label>
            <textarea class="form-control" id="adExcerpt" rows="3" placeholder="Несколько предложений..."></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Категория (id, опционально)</label>
            <input type="number" class="form-control" id="adCategory" placeholder="Напр. 1" />
          </div>
          <div class="mb-3">
            <label class="form-label">Ссылка на Telegram пост (опц.)</label>
            <input type="url" class="form-control" id="adTgUrl" placeholder="https://t.me/..." />
          </div>
          <div class="alert alert-danger d-none" id="adError"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-success" id="saveAdBtn">Создать</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Редактировать профиль</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Новый логин</label>
            <input type="text" class="form-control" id="editUsername" placeholder="новый логин" />
          </div>
          <div class="mb-3">
            <label class="form-label">Новый пароль</label>
            <input type="password" class="form-control" id="editPassword" placeholder="новый пароль" />
          </div>
          <div class="mb-3">
            <label class="form-label">О себе</label>
            <textarea class="form-control" id="editBio" rows="4" placeholder="Коротко о себе"></textarea>
          </div>
          <div class="alert alert-danger d-none" id="editError"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-primary" id="saveProfileBtn">Сохранить</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Up Modal -->
  <div class="modal fade" id="topupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Пополнить баланс</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Сумма (₽)</label>
            <input type="number" step="0.01" min="1" class="form-control" id="topupAmount" placeholder="100.00" />
          </div>
          <div class="text-muted">(Демо) Сразу зачислим сумму на баланс без оплаты.</div>
          <div class="alert alert-danger d-none" id="topupError"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-success" id="confirmTopupBtn">Зачислить</button>
        </div>
      </div>
    </div>
  </div>

  <!-- footer (same as index) -->
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-3">
          <div class="footer__help">
            <h6>Нужна помощь?</h6>
            <div class="phone"><small>Пресс служба</small><span>8 800 555 55 55</span></div>
            <div class="email"><small>Почта для связи</small><span>info@eastnews.com</span></div>
            <div class="public">
              <small>Раскажите о нас</small>
              <div class="public__icon">
                <a href="#"><img src="./assets/images/icons/social_media/vk_icon.png" alt="" /></a>
                <a href="#"><img src="./assets/images/icons/social_media/ok.png" alt="" /></a>
                <a href="#"><img src="./assets/images/icons/social_media/facebook.png" alt="" /></a>
                <a href="#"><img src="./assets/images/icons/social_media/youtube.png" alt="" /></a>
                <a href="#"><img src="./assets/images/icons/social_media/twitter.png" alt="" /></a>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-3">
          <div class="footer__menu">
            <h6>Разделы</h6>
            <div class="menu__list">
              <a href="/category.html">Категории</a>
              <a href="#">Вопросы-ответы</a>
              <a href="#">Полезные советы</a>
              <a href="#">Рекомендации</a>
            </div>
          </div>
        </div>
        <div class="col-lg-3">
          <div class="footer__menu">
            <h6>Ещё</h6>
            <div class="menu__list">
              <a href="#">Мега-скидки</a>
              <a href="#">Что ищут</a>
              <a href="#">Агрегаторы</a>
              <a href="#">Статьи</a>
            </div>
          </div>
        </div>
        <div class="col-lg-3">
          <div class="footer__menu">
            <h6>Кабинет</h6>
            <div class="menu__list">
              <a href="/login">Войти</a>
              <a href="/login">Зарегестрироваться</a>
              <a href="#">Избранное</a>
            </div>
            <div class="footer__social d-flex">
              <a href=""><img src="./assets/images/icons/social_media/appstore.png" alt="" /></a>
              <a href=""><img src="./assets/images/icons/social_media/google.png" alt="" /></a>
              <a href=""><img src="./assets/images/icons/social_media/rustore.png" alt="" /></a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </footer>
  <div class="footer__text"><h6>Copyright 2021-2025 by Magic Worlds</h6></div>

  <!-- Auth UI toggle -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const isFile = window.location.origin.startsWith('file');
        const API_BASE = isFile ? 'http://127.0.0.1:5001' : '';
        const res = await fetch(`${API_BASE}/api/auth/me`, { credentials: 'include' });
        const data = await res.json().catch(() => ({}));
        const headerLinks = Array.from(document.querySelectorAll('header .nav .nav__link.profile'));
        const infoLink = headerLinks.find(a => a.querySelector('.profile_info'));
        const loginLink = headerLinks.find(a => !a.querySelector('.profile_info'));
        if (data && data.authenticated) {
          if (infoLink) {
            infoLink.style.display = '';
            const nameEl = infoLink.querySelector('h6');
            const balEl = infoLink.querySelector('.profile_info span');
            const imgEl = infoLink.querySelector('img');
            if (nameEl && data.user?.username) nameEl.textContent = `@${data.user.username}`;
            if (balEl) balEl.textContent = `Баланс: ${(Number(data.user?.balance || 0)).toFixed(2)}₽`;
            const fallback = './assets/images/user.png';
            const av = (data.user?.avatar_url || '').trim();
            if (imgEl) { imgEl.onerror = () => { imgEl.onerror=null; imgEl.src = fallback; }; imgEl.src = av || fallback; }
          }
          if (loginLink) loginLink.style.display = 'none';
        } else {
          if (infoLink) infoLink.style.display = 'none';
          if (loginLink) {
            loginLink.style.display = '';
            loginLink.setAttribute('href', '/login');
          }
        }
      } catch (e) { /* silent */ }
    });
  </script>
  <!-- Main JS -->
  <script src="assets/js/owl.carousel.min.js"></script>
  <script src="assets/js/main.js"></script>
  <script src="assets/js/octoground.js"></script>
  <!-- Font Awesome -->
  <script src="https://kit.fontawesome.com/1f9ff78b58.js" crossorigin="anonymous"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (async function(){
      try {
        const res = await fetch('/api/auth/me', { credentials: 'include' });
        const data = await res.json().catch(() => ({}));
        if (!data || !data.authenticated) {
          window.location.href = '/login';
          return;
        }
        document.getElementById('username').textContent = `@${data.user.username}`;
        document.getElementById('balance').textContent = `${(Number(data.user.balance || 0)).toFixed(2)}₽`;
        const av = (data.user.avatar_url || '').trim();
        const img = document.getElementById('avatarImg');
        if (img){
          const fallback = '/assets/images/user.png';
          img.onerror = () => { img.onerror=null; img.src = fallback; };
          img.src = av || fallback;
        }
        const bio = (data.user.bio || '').trim();
        const about = document.getElementById('aboutText');
        if (bio && about) about.textContent = bio;
        // rating box
        const rb = document.getElementById('ratingBox');
        if (rb) {
          const avg = Number(data.user.rating_avg || 0);
          const cnt = Number(data.user.rating_count || 0);
          const full = Math.floor(avg);
          const stars = Array.from({length:5}, (_,i)=> i<full ? '<i class="fa-solid fa-star"></i>' : '<i class="fa-regular fa-star"></i>').join('');
          rb.innerHTML = `${stars} <span class="ms-1 small text-muted">(${cnt})</span>`;
        }
        // init tooltips
        Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]')).forEach(el => new bootstrap.Tooltip(el));
      } catch(e) {
        window.location.href = '/login';
      }
    })();

    function showToast(message, variant = 'success') {
      const id = `t_${Date.now()}`;
      const bg = variant === 'success' ? 'bg-success' : variant === 'error' ? 'bg-danger' : 'bg-secondary';
      const el = document.createElement('div');
      el.className = `toast align-items-center text-white ${bg} border-0`;
      el.id = id;
      el.role = 'alert'; el.ariaLive = 'assertive'; el.ariaAtomic = 'true';
      el.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
      const container = document.getElementById('toastContainer');
      container.appendChild(el);
      const t = new bootstrap.Toast(el, { delay: 2500 });
      t.show();
      el.addEventListener('hidden.bs.toast', () => el.remove());
    }

    // Edit Profile Modal logic
    const editModal = new bootstrap.Modal(document.getElementById('editProfileModal'));
    document.getElementById('editProfileBtn').addEventListener('click', () => {
      document.getElementById('editError').classList.add('d-none');
      document.getElementById('editUsername').value = '';
      document.getElementById('editPassword').value = '';
      // prefill bio from the page
      const about = document.getElementById('aboutText');
      document.getElementById('editBio').value = about ? about.textContent.trim() : '';
      editModal.show();
    });
    document.getElementById('saveProfileBtn').addEventListener('click', async () => {
      const username = document.getElementById('editUsername').value.trim();
      const password = document.getElementById('editPassword').value;
      const bio = document.getElementById('editBio').value;
      const err = document.getElementById('editError');
      err.classList.add('d-none');
      try {
        const res = await fetch('/api/me/profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ username, password, bio })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) {
          const map = { weak_username: 'Логин слишком короткий', user_exists: 'Логин уже занят', weak_password: 'Пароль слишком короткий', rename_cooldown: 'Смена логина возможна раз в 24 часа' };
          throw new Error(map[data.error] || 'Ошибка сохранения');
        }
        if (data.user?.username) document.getElementById('username').textContent = `@${data.user.username}`;
        const about = document.getElementById('aboutText');
        if (about) about.textContent = data.user?.bio || '';
        editModal.hide();
        showToast('Профиль обновлён', 'success');
      } catch (e) {
        err.textContent = e.message || 'Ошибка сохранения';
        err.classList.remove('d-none');
        showToast(err.textContent, 'error');
      }
    });

    // Topup Modal logic
    const topupModal = new bootstrap.Modal(document.getElementById('topupModal'));
    document.getElementById('topupBtn').addEventListener('click', () => {
      document.getElementById('topupError').classList.add('d-none');
      document.getElementById('topupAmount').value = '';
      topupModal.show();
    });
    document.getElementById('confirmTopupBtn').addEventListener('click', async () => {
      const amount = parseFloat(document.getElementById('topupAmount').value);
      const err = document.getElementById('topupError');
      err.classList.add('d-none');
      try {
        const res = await fetch('/api/me/topup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ amount })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) throw new Error('Неверная сумма');
        document.getElementById('balance').textContent = `${Number(data.balance).toFixed(2)}₽`;
        topupModal.hide();
        showToast('Баланс пополнен', 'success');
      } catch (e) {
        err.textContent = e.message || 'Ошибка пополнения';
        err.classList.remove('d-none');
        showToast(err.textContent, 'error');
      }
    });

    // My announcements pagination
    let page = 1; const per = 6;
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    async function loadMyAds() {
      const list = document.getElementById('myAds');
      const info = document.getElementById('pagerInfo');
      const totalInfo = document.getElementById('totalInfo');
      const empty = document.getElementById('adsEmpty');
      // skeletons
      list.innerHTML = '';
      for (let i=0;i<3;i++) {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4';
        col.innerHTML = `
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="placeholder-glow">
                <span class="placeholder col-8"></span>
                <span class="placeholder col-6 mt-2"></span>
                <span class="placeholder col-10 mt-2"></span>
              </div>
            </div>
          </div>`;
        list.appendChild(col);
      }
      try {
        const res = await fetch(`/api/me/announcements?page=${page}&per=${per}`, { credentials: 'include' });
        const data = await res.json().catch(() => ({}));
        list.innerHTML = '';
        if (!data.ok) { info.textContent = 'Ошибка загрузки'; totalInfo.textContent=''; return; }
        if (!data.total) {
          empty.classList.remove('d-none');
          info.textContent = '';
          totalInfo.textContent = '';
          prevBtn.disabled = true; nextBtn.disabled = true;
          return;
        }
        empty.classList.add('d-none');
        data.items.forEach(a => {
          const col = document.createElement('div');
          col.className = 'col-md-6 col-lg-4';
          col.innerHTML = `
            <a class="card shadow-sm text-decoration-none" href="/announcement.html?id=${a.id}">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="mb-1" style="color:#114232;">${a.title}</h6>
                  <span class="badge bg-light text-dark">${new Date(a.created_at).toLocaleDateString()}</span>
                </div>
                <p class="mb-2" style="color:#828282;">${(a.excerpt||'').slice(0,120)}</p>
                <span class="badge bg-success"><i class="fa-regular fa-eye me-1"></i>${a.views}</span>
              </div>
            </a>`;
          list.appendChild(col);
        });
        const start = (page-1)*per + 1;
        const end = Math.min(page*per, data.total);
        const pages = Math.max(1, Math.ceil(data.total / per));
        info.textContent = `${start}-${end} из ${data.total}`;
        totalInfo.textContent = `Страница ${page} из ${pages}`;
        prevBtn.disabled = page <= 1;
        nextBtn.disabled = page >= pages;
      } catch(e) {
        list.innerHTML='';
        info.textContent = 'Ошибка загрузки';
        totalInfo.textContent = '';
      }
    }
    prevBtn.addEventListener('click', () => { if (page>1){ page--; loadMyAds(); }});
    nextBtn.addEventListener('click', () => { page++; loadMyAds(); });
    loadMyAds();

    // Load articles
    async function loadArticles() {
      const list = document.getElementById('articlesList');
      const empty = document.getElementById('articlesEmpty');
      if (!list) return;
      list.innerHTML = '';
      try {
        const res = await fetch('/api/me/articles', { credentials: 'include' });
        const data = await res.json().catch(()=>({}));
        if (!res.ok || !data.ok || !data.items?.length) {
          if (empty) empty.classList.remove('d-none');
          return;
        }
        if (empty) empty.classList.add('d-none');
        data.items.forEach(a => {
          const col = document.createElement('div');
          col.className = 'col-md-6 col-lg-4';
          col.innerHTML = `
            <div class="card shadow-sm h-100">
              <img src="https://picsum.photos/seed/art${a.id}/600/340" class="card-img-top" alt="" />
              <div class="card-body">
                <h6 class="mb-1">${a.title}</h6>
                <p class="text-muted small mb-0">${(a.content||'').slice(0,120)}</p>
              </div>
            </div>`;
          list.appendChild(col);
        });
      } catch (e) {
        if (empty) empty.classList.remove('d-none');
      }
    }
    loadArticles();

    // Load reviews
    async function loadReviews() {
      const list = document.getElementById('reviewsList');
      const empty = document.getElementById('reviewsEmpty');
      if (!list) return;
      list.innerHTML = '';
      try {
        const res = await fetch('/api/me/reviews', { credentials: 'include' });
        const data = await res.json().catch(()=>({}));
        if (!res.ok || !data.ok || !data.items?.length) {
          if (empty) empty.classList.remove('d-none');
          return;
        }
        if (empty) empty.classList.add('d-none');
        data.items.forEach(r => {
          const stars = Array.from({length:5}, (_,i)=> i < (r.rating||0) ? '<i class="fa-solid fa-star"></i>' : '<i class="fa-regular fa-star"></i>').join('');
          const col = document.createElement('div');
          col.className = 'col-md-6 col-lg-4';
          col.innerHTML = `
            <div class="card shadow-sm">
              <div class="card-body">
                <div class="d-flex align-items-center mb-2"><i class="fa-solid fa-user-circle me-2"></i><strong>${r.reviewer_name||'Аноним'}</strong><span class="ms-auto small text-muted">${new Date(r.created_at).toLocaleDateString()}</span></div>
                <div class="text-warning mb-2">${stars}</div>
                <p class="mb-2 small">${r.content||''}</p>
              </div>
            </div>`;
          list.appendChild(col);
        });
      } catch (e) {
        if (empty) empty.classList.remove('d-none');
      }
    }
    loadReviews();

    // Create Article UI
    const createArticleModal = new bootstrap.Modal(document.getElementById('createArticleModal'));
    document.getElementById('createArticleBtn').addEventListener('click', () => {
      document.getElementById('articleError').classList.add('d-none');
      document.getElementById('articleTitle').value = '';
      document.getElementById('articleContent').value = '';
      createArticleModal.show();
    });
    document.getElementById('saveArticleBtn').addEventListener('click', async () => {
      const title = document.getElementById('articleTitle').value.trim();
      const content = document.getElementById('articleContent').value.trim();
      const err = document.getElementById('articleError');
      err.classList.add('d-none');
      try {
        const res = await fetch('/api/me/articles', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ title, content }) });
        const data = await res.json().catch(()=>({}));
        if (!res.ok || !data.ok) throw new Error('Заполните заголовок и текст');
        createArticleModal.hide();
        showToast('Статья опубликована', 'success');
        await loadArticles();
      } catch(e) {
        err.textContent = e.message || 'Ошибка публикации';
        err.classList.remove('d-none');
      }
    });

    // Create Review UI
    const createReviewModal = new bootstrap.Modal(document.getElementById('createReviewModal'));
    document.getElementById('createReviewBtn').addEventListener('click', () => {
      document.getElementById('reviewError').classList.add('d-none');
      document.getElementById('reviewerName').value = '';
      document.getElementById('reviewRating').value = '5';
      document.getElementById('reviewContent').value = '';
      createReviewModal.show();
    });
    document.getElementById('saveReviewBtn').addEventListener('click', async () => {
      const reviewer_name = document.getElementById('reviewerName').value.trim();
      const rating = Number(document.getElementById('reviewRating').value);
      const content = document.getElementById('reviewContent').value.trim();
      const err = document.getElementById('reviewError');
      err.classList.add('d-none');
      try {
        const res = await fetch('/api/me/reviews', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ reviewer_name, rating, content }) });
        const data = await res.json().catch(()=>({}));
        if (!res.ok || !data.ok) throw new Error('Проверьте оценку и текст отзыва');
        createReviewModal.hide();
        showToast('Отзыв добавлен', 'success');
        await loadReviews();
        // refresh rating box
        const me = await fetch('/api/auth/me', { credentials:'include' }).then(r=>r.json()).catch(()=>null);
        if (me && me.authenticated) {
          const rb = document.getElementById('ratingBox');
          const avg = Number(me.user.rating_avg || 0);
          const cnt = Number(me.user.rating_count || 0);
          const full = Math.floor(avg);
          const stars = Array.from({length:5}, (_,i)=> i<full ? '<i class=\"fa-solid fa-star\"></i>' : '<i class=\"fa-regular fa-star\"></i>').join('');
          rb.innerHTML = `${stars} <span class=\"ms-1 small text-muted\">(${cnt})</span>`;
        }
      } catch(e) {
        err.textContent = e.message || 'Ошибка добавления отзыва';
        err.classList.remove('d-none');
      }
    });

    // Create Announcement logic
    const createAdModal = new bootstrap.Modal(document.getElementById('createAdModal'));
    document.getElementById('createAdBtn').addEventListener('click', () => {
      document.getElementById('adError').classList.add('d-none');
      document.getElementById('adTitle').value = '';
      document.getElementById('adExcerpt').value = '';
      document.getElementById('adCategory').value = '';
      document.getElementById('adTgUrl').value = '';
      createAdModal.show();
    });
    document.getElementById('saveAdBtn').addEventListener('click', async () => {
      const err = document.getElementById('adError');
      err.classList.add('d-none');
      const title = document.getElementById('adTitle').value.trim();
      const excerpt = document.getElementById('adExcerpt').value.trim();
      const category_id = parseInt(document.getElementById('adCategory').value || '0') || null;
      const tg_post_url = document.getElementById('adTgUrl').value.trim() || null;
      try {
        const res = await fetch('/api/me/announcements', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
          body: JSON.stringify({ title, excerpt, category_id, tg_post_url })
        });
        const data = await res.json().catch(()=>({}));
        if (!res.ok || !data.ok) {
          const map = { title_required: 'Укажите заголовок' };
          throw new Error(map[data.error] || 'Ошибка создания');
        }
        createAdModal.hide();
        showToast('Объявление создано', 'success');
        page = 1; await loadMyAds();
      } catch(e) {
        err.textContent = e.message || 'Ошибка создания';
        err.classList.remove('d-none');
        showToast(err.textContent, 'error');
      }
    });
  </script>
  <script>
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
      } catch(e) {}
      window.location.href = '/';
    });
  </script>
</body>
</html>
